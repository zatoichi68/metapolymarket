rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Collection daily_picks - Cache des analyses quotidiennes
    match /daily_picks/{dateKey} {
      // Lecture autorisée pour tous (données publiques)
      allow read: if true;
      
      // Écriture autorisée seulement si:
      // 1. Le document n'existe pas encore (création uniquement)
      // 2. La clé est une date valide (format YYYY-MM-DD)
      // 3. Les données contiennent les champs requis
      allow create: if isValidDateKey(dateKey)
                    && request.resource.data.keys().hasAll(['date', 'markets', 'updatedAt'])
                    && request.resource.data.date == dateKey
                    && request.resource.data.markets is list;
      
      // Pas de mise à jour ni suppression (cache immuable pour la journée)
      allow update, delete: if false;
    }

    // Collection prediction_history - Historique des prédictions
    match /prediction_history/{dateKey} {
      // Lecture autorisée pour tous
      allow read: if true;
      
      // Écriture autorisée pour créer/mettre à jour les prédictions du jour
      allow create, update: if isValidDateKey(dateKey)
                            && request.resource.data.keys().hasAll(['date', 'predictions', 'stats', 'createdAt'])
                            && request.resource.data.date == dateKey;
      
      allow delete: if false;
    }
    
    // Bloquer tout le reste
    match /{document=**} {
      allow read, write: if false;
    }
  }
  
  // Fonction pour valider le format de date YYYY-MM-DD
  function isValidDateKey(key) {
    return key.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$');
  }
}

