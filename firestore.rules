rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Collection daily_picks - Cache des analyses quotidiennes (PUBLIC)
    match /daily_picks/{dateKey} {
      allow read: if true;
      allow create: if isValidDateKey(dateKey)
                    && request.resource.data.keys().hasAll(['date', 'markets', 'updatedAt'])
                    && request.resource.data.date == dateKey
                    && request.resource.data.markets is list;
      allow update, delete: if false;
    }

    // Collection prediction_history - Historique des prédictions (PUBLIC)
    match /prediction_history/{dateKey} {
      allow read: if true;
      allow create, update: if isValidDateKey(dateKey)
                            && request.resource.data.keys().hasAll(['date', 'predictions', 'stats', 'createdAt'])
                            && request.resource.data.date == dateKey;
      allow delete: if false;
    }

    // Collection hourly_picks - Mises à jour horaires (PUBLIC - filtrage côté client)
    match /hourly_picks/{hourKey} {
      allow read: if true;
      allow create: if isValidHourKey(hourKey)
                    && request.resource.data.keys().hasAll(['timestamp', 'hour', 'markets', 'updatedAt'])
                    && request.resource.data.hour == hourKey
                    && request.resource.data.markets is list;
      allow update: if isValidHourKey(hourKey)
                    && request.resource.data.keys().hasAll(['timestamp', 'hour', 'markets', 'updatedAt']);
      allow delete: if false;
    }

    // ===== COLLECTIONS SENSIBLES - ACCÈS BACKEND UNIQUEMENT =====
    
    // Collection premium_users - Données utilisateurs (PROTÉGÉ)
    // Seul le backend (Admin SDK) peut lire/écrire
    match /premium_users/{email} {
      allow read, write: if false;
    }

    // Collection premium_verifications - Codes de vérification (PROTÉGÉ)
    // Seul le backend (Admin SDK) peut lire/écrire
    match /premium_verifications/{email} {
      allow read, write: if false;
    }
    
    // Bloquer tout le reste par défaut
    match /{document=**} {
      allow read, write: if false;
    }
  }
  
  function isValidDateKey(key) {
    return key.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$');
  }

  function isValidHourKey(key) {
    return key.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}-[0-9]{2}$');
  }
}

